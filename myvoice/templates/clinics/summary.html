{% extends "base.html" %}

{% load static from staticfiles %}

{% block title %}{{ object.name }} {{ object.get_type_display }} Summary Feedback Report{% endblock title %}

{% block content %}
  <div class="container main-header">
    <div class="col-xs-9 no-padding-left">
      <h1>
        <span style="font-weight: 700;">{{ object.name }} {{ object.get_type_display }}</span><br />
         Summary Feedback Report
      </h1>

      <div class="lead">The following document was generated through the
      ICT4SA program, intended to provide trial period reporting to selected
      NSHIP PBF staff. The following data was collected through SMS surveys of
      patients in 11 {{ object.name }} {{ object.get_type_display }} PBF
      Integrated Clinics and some additional community members.</div>
    </div>  
  </div><!-- /.container -->

  
  <div id="feedback-on-services" class="container">
    <div class="col-xs-12 no-padding-left">
      <h1>
        <select id="weeks_filter">
          {% for week in weeks %}
            <option>{{ week.start|date:"F j, Y" }} - {{ week.end|date:"F j, Y" }}</option>
          {% endfor %}
        </select>
      </h1>
    </div>
    <div class="col-xs-12 section-heading">
      <h2>FEEDBACK ON SERVICES</h2>
    </div>

    <p>Number of patients with this service who reported this feedback.</p>

    <table class="table table-bordered table-striped">
      <thead>
        <tr>
            <th class="special-th weeks_filter">{{ min_date|date:"F j, Y" }} - {{ max_date|date:"F j, Y" }}</th>
          <th>Open Facility</th>
          <th>Respectful<br>Staff Treatment</th>
          <th>Clean<br>Hospital Materials</th>
          <th>Charged Fairly</th>
          <th>Most Common<br>Wait Time (hrs)</th>
        </tr>
      </thead>
      
      <tbody>
        {% for service, service_data in feedback_by_service %}
        <tr>
            <td>{{ service.name }}</td>
            {% for result, total_respondents in service_data %}
            {% if result == None %}
              <td>N/A (0)</td>
            {% else %}
              <td>{{ result }} ({{ total_respondents }})</td>
            {% endif %}
            {% endfor %}
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div><!-- / #feedback-on-services .container -->

  <div id="feedback-facility" class="container">
    <div class="col-xs-12 section-heading">
      <h2>FEEDBACK REPORTED BY FACILITY</h2>
    </div>

    <p>Number of patients with this service who reported this feedback.</p>

    <table class="table table-bordered table-striped">
      <thead>
        <tr>
            <th class="special-th weeks_filter">{{ min_date|date:"F j, Y" }} - {{ max_date|date:"F j, Y" }}</th>
          <th>
            <div class="green-question-dot" data-toggle="popover" data-placement="bottom" data-content="This response was generated by using key satisfaction indicators based on customer responses in SMS survey.">?
            </div>
            Feedback<br>Participation
          </th>
          <th>
            <div class="green-question-dot" data-toggle="popover" data-placement="bottom" data-content="This response was generated by using key satisfaction indicators based on customer responses in SMS survey.">?
            </div>
            Patient<br>Satisfaction
          </th>
          <th>
            <div class="green-question-dot" data-toggle="popover" data-placement="bottom" data-content="This response was generated by using key satisfaction indicators based on customer responses in SMS survey.">?
            </div>
            Quality<br>(Score, Q1)
          </th>
          <th>
            <div class="green-question-dot" data-toggle="popover" data-placement="bottom" data-content="This response was generated by using key satisfaction indicators based on customer responses in SMS survey.">?
            </div>
            Quantity<br>(Score, Q1)
          </th>
          <th>
            <div class="green-question-dot" data-toggle="popover" data-placement="bottom" data-content="This response was generated by using key satisfaction indicators based on customer responses in SMS survey.">?
            </div>
            Open<br>Facility
          </th>
          <th>
            <div class="green-question-dot" data-toggle="popover" data-placement="bottom" data-content="This response was generated by using key satisfaction indicators based on customer responses in SMS survey.">?
            </div>
            Respectful<br>Staff Treatment
          </th>
          <th>
            <div class="green-question-dot" data-toggle="popover" data-placement="bottom" data-content="This response was generated by using key satisfaction indicators based on customer responses in SMS survey.">?
            </div>
            Clean<br>Hospital Materials
          </th>
          <th>
            <div class="green-question-dot" data-toggle="popover" data-placement="bottom" data-content="This response was generated by using key satisfaction indicators based on customer responses in SMS survey.">?
            </div>
            Charged<br>Fairly
          </th>
          <th>
            <div class="green-question-dot" data-toggle="popover" data-placement="bottom" data-content="This response was generated by using key satisfaction indicators based on customer responses in SMS survey.">?
            </div>
            Most<br>Common<br>Wait Time<br>(hrs)
          </th>
        </tr>
      </thead>
      <tbody>
      {% for clinic_id, clinic, clinic_data in feedback_by_clinic %}
        <tr id="clinic{{clinic_id}}">
            <td class="clinic_name">{{ clinic }}</td>
            {% for label, result, total_respondents in clinic_data %}
            {% if result == None %}
              <td class="{{label}}">N/A (0)</td>
            {% else %}
              <td class="{{label}}">{{ result }} ({{ total_respondents }})</td>
            {% endif %}
            {% endfor %}
        </tr>
      {% endfor %}

      </tbody>
    </table>
  </div><!-- / #feedback-facility .container -->
{% endblock content %}

{% block js %}

<script src="{% static 'lib/jquery-1.10.2/jquery.min.js' %}"></script>
<script>

 $(document).ready( function () {
  
    $("#weeks_filter").change( function() {
      console.log("Updating Feedback on Services Table");
      filter_feedback_on_services_table();

      $( ".weeks_filter" ).each(function( index ) {
        $( this ).text($("#weeks_filter").val());
      });
    });
});
    
  function filter_feedback_on_services_table() {
    
    // Completion Rate Table - Get Dates from Selected option.
    var start_date = $("#weeks_filter").val().split(" - ")[0];
    var end_date = $("#weeks_filter").val().split(" - ")[1];

    // Send dates via Ajax to our Filter and 
    $.get("/lga_filter_feedback_by_service", {'start_date':start_date, 'end_date':end_date}, function(data,status){
      $.each(data.clinic_data, function(key, value){
        $("tr#"+key+" td.clinic_of").text(value.of_num + "("+value.of_perc+"%)");
        $("tr#"+key+" td.clinic_rst").text(value.rst_num + "("+value.rst_perc+"%)");
        $("tr#"+key+" td.clinic_chm").text(value.chm_num + "("+value.chm_perc+"%)");
        $("tr#"+key+" td.clinic_cf").text(value.cf_num + "("+value.cf_perc+"%)");
        $("tr#"+key+" td.clinic_mcw").text(value.mcw_num + "("+value.mcw_perc+"%)");

      });
    });
  }

  function filter_feedback_table() {
    
    // Completion Rate Table - Selects
    var start_date = $("#frt_start_date").val();
    var end_date = $("#frt_end_date").val();
    var clinic = $("#frt_clinic").val(); 
    var service = $("#frt_service").val();

    $.get("/lga_filter_feedback_by_clinic", {'start_date':start_date, 'end_date':end_date}, function(data,status){
      $.each(data.feedback_data, function(key, value){
        $("tr#clinic"+key+" td.clinic_name").text(value[1][0]);
        $("tr#clinic"+key+" td.feedback_fpp").text(value[2][0][0]);
        $("tr#clinic"+key+" td.feedback_fpn").text(value.[2][0][1]);

       /* name = data[0][0]
        fpp = data[0][1][0][0]
        fpn = data[0][1][0][1]
        psp = data[0][1][1][0]
        psn = data[0][1][1][1]
        qsp = data[0][1][2][0]
        qsn = data[0][1][2][1]
        ofn = data[0][1][3][0]
        ofp = data[0][1][3][1]
        rsp = data[0][1][4][0]
        rsn = data[0][1][4][1]
        cmp = data[0][1][5][0]
        cmn = data[0][1][5][1]
        cfp = data[0][1][6][0]
        cfn = data[0][1][6][1]
        cwp = data[0][1][7][0]
        cwn = data[0][1][7][1]
        cwp = data[0][1][8][0]
        cwn = data[0][1][8][1]



        feedback Participation 
        Patient Satisfaction  
        Quality (Score, Q1) 
        Quantity (Score, Q1) 
        Open Facility  
        Respectful Staff Treatment 
        Clean Hospital Materials  
        Charged Fairly  
        Most Common Wait Time*/
      });
    });
  }

</script>
{% endblock js %}
