{% extends "base.html" %}
{% load humanize %}

{% load static from staticfiles %}

{% block title %}{{ object.name }} {{ object.get_type_display }} Summary Feedback Report{% endblock title %}

{% block content %}
  <div class="container main-header">
    <div class="col-xs-9 no-padding-left">
      <h1>
        <span style="font-weight: 700;">{{ object.name }} {{ object.get_type_display }}</span><br />
         Summary Feedback Report
      </h1>

      <div class="lead">The following document was generated through the
      ICT4SA program, intended to provide trial period reporting to selected
      NSHIP PBF staff. The following data was collected through SMS surveys of
      patients in 11 {{ object.name }} {{ object.get_type_display }} PBF
      Integrated Clinics and some additional community members.</div>
    </div>  
  </div><!-- /.container -->

  
  <div id="feedback-on-services" class="container">
    <div class="col-xs-12 no-padding-left web-only">
      <h1>
      <div class="styled-select full-width">
        <select id="weeks_filter" dir="rtl" class="float-right">
          {% for week in weeks %}
            {% if forloop.first %} 
              <option value="{{ week.start|date:"F j, Y" }} - {{ week.end|date:"F j, Y" }}">All Weeks</option>
            {% else %}
              <option>{{ week.start|date:"F j, Y" }} - {{ week.end|date:"F j, Y" }}</option>            
            {% endif %}
          {% endfor %}
        </select>
      </div>
      </h1>
    </div>
    <div class="col-xs-12 section-heading">
      <h2>FEEDBACK ON SERVICES</h2>
    </div>

    <div class="col-xs-12 section-heading print-only" style="padding: 0px">
      <img src="{% static 'img/lt-grey-img.jpg' %}" style="width: 100%; height: 30px; padding:0px">
      <h2 style="position: absolute; top: 7px; left: 15px;">FEEDBACK ON SERVICES</h2>
    </div>


    <p>Number of patients with this service who reported this feedback.</p>

    <table class="table table-bordered table-striped web-only">
      <thead>
        <tr>
          <th class="special-th weeks_filter">Services {{ min_date|date:"F j, Y" }} - {{ max_date|date:"F j, Y" }}</th>
          {% for heading in service_labels %}
            <th>{{ heading }}</th>
          {% endfor %}
        </tr>
      </thead>
      
      <tbody>
        {% for service, service_data in feedback_by_service %}
        <tr id="service{{ service.id }}">
            <td id="service_name">{{ service.name }}</td>
            {% for label, result, total_respondents in service_data %}
              {% if result == None %}
                <td class="{{ label }}">N/A (0)</td>
              {% else %}
                <td class="{{ label }}">{{ result }} ({{ total_respondents }})</td>
              {% endif %}
            {% endfor %}
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div><!-- / #feedback-on-services .container -->

  <div id="feedback-facility" class="container">
    <div class="col-xs-12 section-heading web-only">
      <h2>FEEDBACK REPORTED BY FACILITY</h2>
    </div>

    <div class="col-xs-12 section-heading print-only" style="padding: 0px">
      <img src="{% static 'img/lt-grey-img.jpg' %}" style="width: 100%; height: 30px; padding:0px">
      <h2 style="position: absolute; top: 7px; left: 15px;">FEEDBACK REPORTED BY FACILITY</h2>
    </div>
      

    <p>Number of patients with this service who reported this feedback.</p>

    <table class="table table-bordered table-striped web-only">
      <thead>
        <tr>
            <th class="special-th weeks_filter">{{ min_date|date:"F j, Y" }} - {{ max_date|date:"F j, Y" }}</th>
            {% for heading in clinic_labels %}
              <th>
                <div class="green-question-dot" data-toggle="popover" data-placement="bottom" data-content="This response was generated by using key satisfaction indicators based on customer responses in SMS survey.">?</div>
                {{ heading }}
              </th>
            {% endfor %}
        </tr>
      </thead>
      <tbody>
      {% for clinic_id, clinic, clinic_data in feedback_by_clinic %}
        <tr id="clinic{{clinic_id}}">
            <td class="clinic_name">{{ clinic }}</td>
            {% for label, result, total_respondents in clinic_data %}
            {% if result == None %}
              <td class="{{label}}">N/A (0)</td>
            {% else %}
              {% if total_respondents %}
                <td class="{{label}}">{{ result }} ({{ total_respondents }})</td>
              {% else %}
                {% if label == "Quality" %}
                  <td class="{{label}}">{{ result }}</td>
                {% else %}
                  <td class="{{label}}">{{ result|intcomma }}</td>
                {% endif %}
              {% endif %}
            {% endif %}
            {% endfor %}
        </tr>
      {% endfor %}

      </tbody>
    </table>

      <table class="table table-bordered table-striped print-only">
      <thead>
        <tr>
            <th class="special-th">Facility {{ min_date|date:"F j, Y" }}-{{ max_date|date:"F j, Y" }}</th>
          <th>
            Feedback<br>Participation
          </th>
          <th>
            Patient<br>Satisfaction
          </th>
          <th>
            Quality<br>(Score, Q1)
          </th>
          <th>
            Quantity<br>(Score, Q1)
          </th>
          <th>
            Open<br>Facility
          </th>
          <th>
            Respectful<br>Staff Treatment
          </th>
          <th>
            Clean<br>Hospital Materials
          </th>
          <th>
            Charged<br>Fairly
          </th>
          <th>
            Most<br>Common<br>Wait Time<br>(hrs)
          </th>
        </tr>
      </thead>
      <tbody>
      {% for clinic, clinic_data in feedback_by_clinic %}
        <tr>
            <td>{{ clinic }}</td>
            {% for result, total_respondents in clinic_data %}
            {% if result == None %}
              <td>N/A (0)</td>
            {% else %}
              <td>{{ result }} ({{ total_respondents }})</td>
            {% endif %}
            {% endfor %}
        </tr>
        {% if forloop.counter == 3 %}
          </table>
          <div class="print-break"></div><br/><br/>
          <table class="table table-bordered table-striped print-only">
          <thead>
            <tr>
                <th class="special-th">{{ min_date|date:"F j, Y" }}-{{ max_date|date:"F j, Y" }}</th>
              <th>
                Feedback<br>Participation
              </th>
              <th>
                Patient<br>Satisfaction
              </th>
              <th>
                Quality<br>(Score, Q1)
              </th>
              <th>
                Quantity<br>(Score, Q1)
              </th>
              <th>
                Open<br>Facility
              </th>
              <th>
                Respectful<br>Staff Treatment
              </th>
              <th>
                Clean<br>Hospital Materials
              </th>
              <th>
                Charged<br>Fairly
              </th>
              <th>
                Most<br>Common<br>Wait Time<br>(hrs)
              </th>
            </tr>
          </thead>
        {% endif %}
      {% endfor %}
      </tbody>
    </table>

  </div><!-- / #feedback-facility .container -->
{% endblock content %}

{% block js %}

<script src="{% static 'lib/jquery-1.10.2/jquery.min.js' %}"></script>
<script>

 $(document).ready( function () {

    $("#weeks_filter").change( function() {
      filter_feedback_on_services_table();
      filter_feedback_on_clinics_table();

      // Update the Values within the Charts to the Select Value
      $( ".weeks_filter" ).each(function( index ) {
        $( this ).text($("#weeks_filter").val());
      });
    });
});

  function filter_feedback_on_services_table() {

    // Completion Rate Table - Get Dates from Selected option.
    var start_date = $("#weeks_filter").val().split(" - ")[0];
    var end_date = $("#weeks_filter").val().split(" - ")[1];

    // Send dates via Ajax to our Filter and 
    $.get("/lga_filter_feedback_by_service", {'start_date':start_date, 'end_date':end_date}, function(data,status){
            $('div#feedback-on-services > table.web-only').html(data);
            return;
      $.each(data, function(num, results){

        id = results[0];
        name = results[1];
        core_data = results[2];

        $.each(core_data, function(num, results2){
          label = results2[0];
          perc = results2[1];
          num = results2[2];

          $("tr#service"+id+" td."+label).text(perc + " ("+num+")");
        });
      });
    });
  }

  function filter_feedback_on_clinics_table() {

    // Completion Rate Table - Selects
    var start_date = $("#weeks_filter").val().split(" - ")[0];
    var end_date = $("#weeks_filter").val().split(" - ")[1];

    $.get("/lga_filter_feedback_by_clinic", {'start_date':start_date, 'end_date':end_date}, function(data, status){
        $('div#feedback-facility > table.web-only').html(data);
         return;
      $.each(data, function(num, results ){
        id = results[0];
        name = results[1];
        core_data = results[2];

        $.each(core_data, function(num, results2){
          label = results2[0];
          perc = results2[1];
          num = results2[2];

          $("tr#clinic"+id+" td."+label).text(perc + "(" + num + ")");
        });
      });
    });
  }

</script>
{% endblock js %}
